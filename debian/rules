#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

PYVERS := $(shell pyversions -v -r debian/control)
DEFPY := $(shell pyversions -v -d)
pd  := python-matplotlib-doc
p   := python-matplotlib
pdata := python-matplotlib-data

include /usr/share/quilt/quilt.make

# build
build: patch build-arch build-indep

build-indep: build-indep-stamp
build-indep-stamp: $(DEFPY:%=build-stamp-%)
	dh_testdir

	# build the doc
	-( cd doc ; MATPLOTLIBDATA=../lib/matplotlib/mpl-data/ \
		    PYTHONPATH=../build/lib.$(shell dpkg-architecture -qDEB_BUILD_ARCH_OS)-$(shell dpkg-architecture -qDEB_BUILD_GNU_CPU)-$(DEFPY) ./make.py )

	touch build-indep-stamp

build-arch:$(PYVERS:%=build-stamp-%)

build-stamp-%:
	dh_testdir
	python$* ./setup.py build $(PY_BUILD_FLAGS)
	touch $@


# clean
clean: clean-patched unpatch
clean-patched: patch
	dh_testdir
	dh_testroot
	for i in $(PYVERS); do python$(i) ./setup.py clean --all; done
	-rm -f *-stamp*
	-rm -rf build *.pyc *.pyo

	rm -f lib/matplotlib/mpl-data/matplotlib.conf lib/matplotlib/mpl-data/matplotlibrc

	# clean the doc
	( cd doc ; ./make.py clean )
	rm -f doc/_static/inheritance*
	rm -f doc/_static/math-*.png
	rm -f doc/test.png
	find . -name '*.pyc' -exec rm {} \;

	dh_clean

# install
install-arch: build-arch $(PYVERS:%=install-stamp-%)
	dh_testdir
	dh_testroot

install-stamp-%: build-stamp-%
	dh_testdir
	dh_testroot
	python$* ./setup.py install_lib \
		-d $(CURDIR)/debian/$(p)/usr/lib/python$*/site-packages/ --no-compile
	rm -rf $(CURDIR)/debian/$(p)/usr/lib/python$*/site-packages/matplotlib/mpl-data/
	rm -rf $(CURDIR)/debian/$(p)/usr/lib/python$*/site-packages/matplotlib/backends/Matplotlib.nib/

	touch $@

install-indep: build-indep
	dh_testdir -i
	dh_testroot -i
	dh_clean -k
	dh_install -p $(pdata)
	rm -fr $(CURDIR)/debian/$(pdata)/usr/share/matplotlib/mpl-data/fonts/ttf/Vera*.ttf
	rm -fr $(CURDIR)/debian/$(pdata)/usr/share/matplotlib/mpl-data/fonts/ttf/*.TXT
	rm -fr $(CURDIR)/debian/$(pdata)/usr/share/matplotlib/mpl-data/fonts/ttf/local.conf
	rm -fr $(CURDIR)/debian/$(pdata)/usr/share/matplotlib/mpl-data/fonts/pdfcorefonts/readme.txt
	chmod 644 $(CURDIR)/debian/$(pdata)/usr/share/matplotlib/mpl-data/images/*.svg


# binary
binary-indep: build-indep install-indep
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs -i CHANGELOG
	dh_installdocs -p$(pd) -i doc/build/html/ doc/build/latex/Matplotlib.pdf
	dh_installexamples -p$(pd) -i examples/*
	dh_compress -i -Xexamples -Xexamples/data -Xpdf -X.js
	ln -sf /usr/share/javascript/jquery/jquery.js \
		$(CURDIR)/debian/$(pd)/usr/share/doc/python-matplotlib-doc/html/_static/jquery.js
	dh_link -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary-arch: build-arch install-arch
	dh_testdir -a
	dh_testroot -a
	dh_installchangelogs -a CHANGELOG
	dh_installdocs -p$(p) -a README.txt TODO API_CHANGES KNOWN_BUGS INTERACTIVE
	# make python scripts starting with '#!' executable
	for i in `find debian -mindepth 2 -type f ! -perm 755`; do \
	  if head -1 $$i | grep -q '^#!'; then \
	    chmod 755 $$i; \
	    echo "made executable: $$i"; \
	  fi; \
	done
	dh_pycentral -a
	dh_link -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
